#!/usr/bin/env groovy

def SLAVE_NODE = ''

pipeline {
  agent {
    label 'sinter-mac'
  }

  stages {
    stage('Build') {
      steps {
        script {
          SLAVE_NODE = sh(script: 'hostname -s', returnStdout: true).trim()
        }
          
        sh '''
        echo "Build OSXScraper..."
        cd osxscraper
        xcodebuild -list -project OSXScraper.xcodeproj
        xcodebuild -scheme OSXScraper build

        echo "Build OSXProxy..."
        cd ../osxproxy
        xcodebuild -list -project OSXProxy.xcodeproj
        xcodebuild -scheme OSXProxy build
        '''
          
      }
    }

    stage('Unit Testing') {
      steps {
        timeout(time: 1, unit: 'HOURS'){
          sh '''
            echo "Test(s) go here"
            mkdir -p testoutput
            cd osxscraper
            /Applications/Calculator.app/Contents/MacOS/Calculator &

            echo "build-for-testing"
            xcodebuild build-for-testing -project OSXScraper.xcodeproj -scheme OSXScraper

            echo "clean the TCC.db"
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" 'select * from access'
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "SELECT name FROM PRAGMA_TABLE_INFO('access')"
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "delete from access where client='edu.unc.OSXScraper' and service='kTCCServiceAccessibility'"
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" 'select * from access'

            echo "test-without-building, run 1 case to enable Accessibility access magically"
            xcodebuild test-without-building -project OSXScraper.xcodeproj -scheme OSXScraper -only-testing:OSXScraperTests/OSXScrapperTests/test001_LS_Self

            echo "enable the allow access in TCC.db"
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" 'select * from access'
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "SELECT name FROM PRAGMA_TABLE_INFO('access')"
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" 'UPDATE access SET allowed = "1";'
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" 'select * from access'

            echo "test-without-building, run the testcases"
            xcodebuild test-without-building -project OSXScraper.xcodeproj -scheme OSXScraper
            ls -lht ../testoutput/
          '''
        }
      }
    }
  }
}
